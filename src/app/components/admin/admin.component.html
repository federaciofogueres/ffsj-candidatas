@if (!loading) {
<div class="admin-wrapper">
    <div class="top-actions d-flex justify-content-end mb-3">
        <button class="btn btn-foc-rojo" mat-button [matMenuTriggerFor]="menuDescargas">Descargar</button>
        <mat-menu #menuDescargas="matMenu">
            <button mat-menu-item (click)="download()">Todo</button>
            <button mat-menu-item (click)="download('informacionPersonal')">Información personal</button>
            <button mat-menu-item (click)="download('vidaEnFogueres')">Vida en fogueres</button>
            <button mat-menu-item (click)="download('academico')">Académico</button>
        </mat-menu>
    </div>

    <mat-tab-group dynamicHeight class="tabs-wrapper" (selectedTabChange)="onTabChange($event)">

        <!-- TAB ADULTAS -->
        <mat-tab label="Adultas">
            <div class="tab-body">
                <ng-container *ngTemplateOutlet="searchBar; context: { tipo: 'adultas' }"></ng-container>

                <div class="scrollable-container mat-elevation-z4">
                    <table mat-table [dataSource]="adultasDataSource" matSort #sortAdultas="matSort"
                        class="mat-elevation-z8 compact-table" role="table">

                        <!-- ID -->
                        <ng-container matColumnDef="id">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
                            <td mat-cell *matCellDef="let element"> {{ element.id }} </td>
                        </ng-container>

                        <!-- Foguera -->
                        <ng-container matColumnDef="foguera">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Foguera </th>
                            <td mat-cell *matCellDef="let element" class="foguera-cell"> {{ element.foguera }} </td>
                        </ng-container>

                        @for (columna of columnasAdultas.slice(2); track $index) {
                        <ng-container matColumnDef="{{ columna }}">
                            <th mat-header-cell *matHeaderCellDef>
                                {{ columnasAdultasText[$index + 2] }}
                            </th>
                            <td mat-cell *matCellDef="let element; let j = index">
                                <div class="status-cell">
                                    @if (element[columna] === 'Completo') {
                                    <span class="text-verde"><mat-icon>check</mat-icon></span>
                                    } @else {
                                    <span class="text-rojo"><mat-icon>close</mat-icon></span>
                                    }
                                    <mat-icon class="action-icon"
                                        (click)="openDialog('adultas', element, columna)">visibility</mat-icon>
                                </div>
                            </td>
                        </ng-container>
                        }
                        <!-- Columna REVISADO (adultas) -->
                        <ng-container matColumnDef="revisado">
                            <th mat-header-cell *matHeaderCellDef> Revisado </th>
                            <td mat-cell *matCellDef="let element">
                                <mat-checkbox [checked]="element.revisado"
                                    (change)="marcarRevisado(element, 'adultas')">
                                </mat-checkbox>
                            </td>
                        </ng-container>
                        <tr mat-header-row *matHeaderRowDef="displayedColumnsAdultas"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumnsAdultas;"
                            [ngClass]="getRowClass(row, 'adultas')">
                        </tr>
                    </table>

                    <mat-paginator #paginatorAdultas [pageSizeOptions]="[5,10,25,50]" [pageSize]="10"
                        showFirstLastButtons>
                    </mat-paginator>
                </div>
            </div>
        </mat-tab>

        <!-- TAB INFANTILES -->
        <mat-tab label="Infantiles">
            <div class="tab-body">
                <ng-container *ngTemplateOutlet="searchBar; context: { tipo: 'infantiles' }"></ng-container>

                <div class="scrollable-container mat-elevation-z4">
                    <table mat-table [dataSource]="infantilesDataSource" matSort #sortInfantiles="matSort"
                        class="mat-elevation-z8 compact-table" role="table">

                        <!-- ID -->
                        <ng-container matColumnDef="id">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
                            <td mat-cell *matCellDef="let element"> {{ element.id }} </td>
                        </ng-container>

                        <!-- Foguera -->
                        <ng-container matColumnDef="foguera">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header> Foguera </th>
                            <td mat-cell *matCellDef="let element" class="foguera-cell"> {{ element.foguera }} </td>
                        </ng-container>

                        @for (columna of columnasInfantiles.slice(2); track $index) {
                        <ng-container matColumnDef="{{ columna }}">
                            <th mat-header-cell *matHeaderCellDef>
                                {{ columnasInfantilesText[$index + 2] }}
                            </th>
                            <td mat-cell *matCellDef="let element; let j = index">
                                <div class="status-cell">
                                    @if (element[columna] === 'Completo') {
                                    <span class="text-verde"><mat-icon>check</mat-icon></span>
                                    } @else {
                                    <span class="text-rojo"><mat-icon>close</mat-icon></span>
                                    }
                                    <mat-icon class="action-icon"
                                        (click)="openDialog('infantiles', element, columna)">visibility</mat-icon>
                                </div>
                            </td>
                        </ng-container>
                        }
                        <!-- Columna REVISADO (infantiles) -->
                        <ng-container matColumnDef="revisado">
                            <th mat-header-cell *matHeaderCellDef> Revisado </th>
                            <td mat-cell *matCellDef="let element">
                                <mat-checkbox [checked]="element.revisado"
                                    (change)="marcarRevisado(element, 'infantiles')">
                                </mat-checkbox>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumnsInfantiles"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumnsInfantiles;"
                            [ngClass]="getRowClass(row, 'infantiles')">
                        </tr>
                    </table>

                    <mat-paginator #paginatorInfantiles [pageSizeOptions]="[5,10,25,50]" [pageSize]="10"
                        showFirstLastButtons>
                    </mat-paginator>
                </div>
            </div>
        </mat-tab>
    </mat-tab-group>
</div>
}

<!-- buscador -->
<ng-template #searchBar let-tipo="tipo">
    <div class="table-toolbar d-flex gap-3 align-items-center flex-wrap">

        <!-- Buscador de texto -->
        <mat-form-field appearance="outline" class="search-field">
            <mat-label>Buscar</mat-label>
            <input #searchInput matInput type="text" (input)="applyFilter($any($event.target).value, tipo)"
                placeholder="Buscar en la tabla" />
            @if (
            (tipo === 'adultas' &&
            ((adultasDataSource &&
            adultasDataSource.filter &&
            adultasDataSource.filter.length) || 0) > 0)
            ||
            (tipo === 'infantiles' &&
            ((infantilesDataSource &&
            infantilesDataSource.filter &&
            infantilesDataSource.filter.length) || 0) > 0)
            ) {
            <button matSuffix mat-icon-button aria-label="Limpiar" type="button"
                (click)="applyFilter('', tipo); searchInput.value = '';">
                <mat-icon>close</mat-icon>
            </button>
            }
        </mat-form-field>

        <!-- Desplegable Filtros -->
        <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Filtros</mat-label>
            <mat-select [value]="
          tipo === 'adultas'
            ? selectedFilterAdultas
            : selectedFilterInfantiles
        " (selectionChange)="onFilterChange($event.value, tipo)">
                <!-- sin filtro -->
                <mat-option value="">Todos</mat-option>

                <!-- Pendiente = algo por completar -->
                <mat-option value="pendiente">Tiene documentación pendiente</mat-option>

                <!-- Secciones concretas (clave = nombre de la columna en InfoShowTable) -->
                <mat-option value="informacionPersonal">Información personal completo</mat-option>
                <mat-option value="vidaEnFogueres">Vida en fogueres completo</mat-option>
                <mat-option value="academico">Académico completo</mat-option>
                <mat-option value="documentacion">Documentación completa</mat-option>

                @if (tipo === 'infantiles') {
                <mat-option value="responsables">Responsables completo</mat-option>
                }

                <!-- Todo completo -->
                <mat-option value="todo">Todo completo</mat-option>
            </mat-select>
        </mat-form-field>
    </div>
</ng-template>