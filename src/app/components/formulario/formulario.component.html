@if (loading) {
<lib-ffsj-spinner [fullscreen]="true"></lib-ffsj-spinner>
} @else {
<div class="formulario-container">
    <mat-stepper orientation="vertical" [linear]="false" #stepper>
        <ng-template matStepperIcon="edit" let-index="index">
            @if (isStepCompleted(index)) {
            <mat-icon>check</mat-icon>
            } @else {
            <mat-icon>edit</mat-icon>
            }
        </ng-template>

        @if (visor === 'formulario') {

        <!-- 1. Datos personales -->
        <mat-step [stepControl]="personalInfo">
            <form [formGroup]="personalInfo">
                <ng-template matStepLabel>Datos personales</ng-template>

                <div class="form-group mb-3">
                    <label class="text-naranja">Tipo de Candidata</label>
                    <mat-radio-group formControlName="tipoCandidata">
                        <mat-radio-button value="adultas">Adulta</mat-radio-button>
                        <mat-radio-button value="infantiles">Infantil</mat-radio-button>
                    </mat-radio-group>
                </div>

                <app-form-field label="DNI/NIF" forId="dni" [control]="personalInfo.get('dni')"
                    errorMessage="El DNI es obligatorio.">
                </app-form-field>

                <app-form-field label="Nombre completo" forId="nombre" [control]="personalInfo.get('nombre')"
                    errorMessage="El nombre es obligatorio.">
                </app-form-field>

                <app-form-field label="Fecha de nacimiento" forId="fechaNacimiento" type="date"
                    [control]="personalInfo.get('fechaNacimiento')"
                    errorMessage="La fecha de nacimiento es obligatoria.">
                </app-form-field>

                <app-form-field label="Ciudad" forId="ciudad" [control]="personalInfo.get('ciudad')"
                    errorMessage="Hay errores con la ciudad.">
                </app-form-field>

                <app-form-field label="Tel茅fono" forId="telefono" [control]="personalInfo.get('telefono')"
                    errorMessage="Hay errores con el tel茅fono.">
                </app-form-field>

                <app-form-field label="Email" forId="email" type="email" [control]="personalInfo.get('email')"
                    errorMessage="Hay errores con el email.">
                </app-form-field>
            </form>
        </mat-step>

        <!-- 2. Responsable (solo infantiles) -->
        @if (personalInfo.get('tipoCandidata')?.value === 'infantiles') {
        <mat-step [stepControl]="responsableInfo">
            <form [formGroup]="responsableInfo">
                <ng-template matStepLabel>Informaci贸n del Responsable</ng-template>

                <span class="text-rojo mb-2 d-block">
                    En caso de limitaci贸n de patria potestad, indicad solo el nombre y tel茅fono de quien la ostente.
                </span>

                <app-form-field label="Nombre del/la Tutor/a 1" forId="nombreTutor1"
                    [control]="responsableInfo.get('nombreTutor1')" errorMessage="Hay errores con el nombre.">
                </app-form-field>

                <app-form-field label="Tel茅fono del/la Tutor/a 1" forId="telefonoTutor1"
                    [control]="responsableInfo.get('telefonoTutor1')" errorMessage="Hay errores con el tel茅fono.">
                </app-form-field>

                <app-form-field label="Nombre del/la Tutor/a 2" forId="nombreTutor2"
                    [control]="responsableInfo.get('nombreTutor2')">
                </app-form-field>

                <app-form-field label="Tel茅fono del/la Tutor/a 2" forId="telefonoTutor2"
                    [control]="responsableInfo.get('telefonoTutor2')">
                </app-form-field>
            </form>
        </mat-step>
        }

        <!-- 3. Datos de la fiesta -->
        <mat-step [stepControl]="fogueresInfo">
            <form [formGroup]="fogueresInfo">
                <ng-template matStepLabel>Datos de la fiesta</ng-template>

                <div class="form-group mb-3">
                    <label for="asociacion" class="text-naranja">Asociaci贸n</label>
                    <select id="asociacion" class="form-control" formControlName="asociacion" required>
                        @for (asociacion of asociaciones; track $index) {
                        <option [value]="asociacion.id">{{ asociacion.nombre }}</option>
                        }
                    </select>
                    <app-form-error [control]="fogueresInfo.get('asociacion')"
                        message="Hay errores con la asociaci贸n, por favor, selecciona una de la lista.">
                    </app-form-error>
                </div>

                <app-form-field label="A帽os en la fiesta" forId="anyosFiesta" type="number"
                    [control]="fogueresInfo.get('anyosFiesta')" errorMessage="Introduce un valor v谩lido.">
                </app-form-field>

                <!-- curriculum mantiene su estructura porque es distinta -->
                <div formGroupName="curriculum">
                    <span class="h3 text-naranja">Curriculum festero</span>

                    <app-form-field label="Cargo" forId="cargo" [control]="fogueresInfo.get('curriculum.cargo')">
                    </app-form-field>

                    <div class="d-flex justify-content-between align-items-end gap-2">
                        <app-form-field label="Desde" forId="comienzo" type="number"
                            [control]="fogueresInfo.get('curriculum.comienzo')">
                        </app-form-field>

                        <app-form-field label="Hasta" forId="final" type="number"
                            [control]="fogueresInfo.get('curriculum.final')">
                        </app-form-field>

                        <button type="button" style="height: 38px;" class="btn btn-primary"
                            (click)="addCurriculum()">A帽adir</button>
                    </div>

                    <ul class="mt-3">
                        @for (cargo of cargos; track cargo; let i = $index) {
                        <li class="d-flex align-items-center gap-2">
                            <span>
                                {{ cargo.cargo | titlecase }} -
                                @if (cargo.comienzo === cargo.final) {
                                A帽o {{ cargo.comienzo }}
                                } @else {
                                A帽os {{ cargo.comienzo }} - {{ cargo.final }}
                                }
                            </span>
                            <button mat-icon-button color="warn" (click)="removeCurriculum(i)">
                                <mat-icon>close</mat-icon>
                            </button>
                        </li>
                        }
                    </ul>
                </div>
            </form>
        </mat-step>

        <!-- 4. Acad茅mico -->
        <mat-step [stepControl]="academicInfo">
            <form [formGroup]="academicInfo">
                <ng-template matStepLabel>Formaci贸n e informaci贸n adicional</ng-template>

                <app-form-field label="Formaci贸n" forId="formacion" [control]="academicInfo.get('formacion')"
                    errorMessage="La formaci贸n es obligatoria.">
                </app-form-field>

                @if (personalInfo.get('tipoCandidata')?.value === 'adultas') {
                <app-form-field label="Situaci贸n laboral" forId="situacionLaboral"
                    [control]="academicInfo.get('situacionLaboral')"
                    errorMessage="La situaci贸n laboral es obligatoria para adultas.">
                </app-form-field>
                }

                <app-form-field label="Aficiones" forId="aficiones" [control]="academicInfo.get('aficiones')"
                    errorMessage="Las aficiones son obligatorias.">
                </app-form-field>

                <div class="form-group mb-3">
                    <mat-checkbox formControlName="aceptoTratamiento" (change)="toggleObservaciones($event)"
                        class="text-rojo">
                        Acepto el tratamiento de mis "observaciones"
                    </mat-checkbox>
                </div>

                <app-form-field label="Observaciones (alergias, intolerancias...)" forId="observaciones" type="textarea"
                    [control]="academicInfo.get('observaciones')"
                    errorMessage="Hay alg煤n error, por favor, revisa las observaciones.">
                </app-form-field>
            </form>
        </mat-step>
        }

        <!-- 5. Documentaci贸n -->
        <mat-step [stepControl]="documentacionForm">
            <ng-template matStepLabel>Documentaci贸n</ng-template>
            <form [formGroup]="documentacionForm">
                @for (f of fileFields; track f.name) {
                <div class="form-group mb-3">
                    <label [for]="f.name" class="text-naranja">{{ f.label }}</label>

                    @if (existingDocuments && existingDocuments[f.name]) {
                    <!-- Hay documento ya subido en Firebase -->
                    <div class="existing-file d-flex flex-column gap-1">
                        <small class="text-muted">
                             Documento ya subido:
                            <a [href]="existingDocuments[f.name]" target="_blank">
                                {{ getFileName(existingDocuments[f.name]) }}
                            </a>
                        </small>

                        <button type="button" class="btn btn-outline-primary btn-sm align-self-start"
                            (click)="replaceDocument(f.name)">
                            Reemplazar documento
                        </button>
                    </div>
                    } @else {
                    <!-- No hay documento o el usuario ha elegido reemplazarlo -->
                    <input [id]="f.name" type="file" class="form-control" (change)="onFileChange($event, f.name)" />

                    <app-form-error [control]="documentacionForm.get(f.name)"
                        message="El archivo debe pesar menos de 5MB.">
                    </app-form-error>
                    }
                </div>
                }
            </form>
        </mat-step>

    </mat-stepper>

    <div class="container mt-3">
        <button type="submit" class="btn btn-primary btn-foc-rojo w-100" (click)="onSubmit()" [disabled]="loading">
            Enviar
        </button>
    </div>

</div>
}