@if (loading) {
<lib-ffsj-spinner [fullscreen]="true"></lib-ffsj-spinner>
} @else {
<div class="formulario-container">

    <mat-stepper orientation="vertical" [linear]="false" #stepper>
        <!-- icono del lápiz → check si el step está OK -->
        <ng-template matStepperIcon="edit" let-index="index">
            @if (isStepCompleted(index)) {
            <mat-icon>check</mat-icon>
            } @else {
            <mat-icon>edit</mat-icon>
            }
        </ng-template>

        @if (visor === 'formulario') {

        <!-- ========== STEP 1: DATOS PERSONALES ========== -->
        <mat-step [stepControl]="personalInfo">
            <form [formGroup]="personalInfo">
                <ng-template matStepLabel>Datos personales</ng-template>

                <!-- tipo de candidata -->
                <div class="form-group mb-3">
                    <label class="text-naranja">Tipo de Candidata</label>
                    <mat-radio-group formControlName="tipoCandidata">
                        <mat-radio-button value="adultas">Adulta</mat-radio-button>
                        <mat-radio-button value="infantiles">Infantil</mat-radio-button>
                    </mat-radio-group>
                </div>

                <!-- DNI -->
                <div class="form-group mb-3">
                    <label for="dni" class="text-naranja">DNI/NIF</label>
                    <input id="dni" type="text" class="form-control" formControlName="dni" required>
                    <app-form-error [control]="personalInfo.get('dni')" message="El DNI es obligatorio.">
                    </app-form-error>
                </div>

                <!-- Nombre -->
                <div class="form-group mb-3">
                    <label for="nombre" class="text-naranja">Nombre completo</label>
                    <input id="nombre" type="text" class="form-control" formControlName="nombre" required>
                    <app-form-error [control]="personalInfo.get('nombre')" message="El nombre es obligatorio.">
                    </app-form-error>
                </div>

                <!-- Fecha nacimiento -->
                <div class="form-group mb-3">
                    <label for="fechaNacimiento" class="text-naranja">Fecha de Nacimiento</label>
                    <input id="fechaNacimiento" type="date" class="form-control" formControlName="fechaNacimiento"
                        required>
                    <app-form-error [control]="personalInfo.get('fechaNacimiento')"
                        message="La fecha de nacimiento es obligatoria.">
                    </app-form-error>
                </div>

                <!-- Ciudad -->
                <div class="form-group mb-3">
                    <label for="ciudad" class="text-naranja">Ciudad</label>
                    <input id="ciudad" type="text" class="form-control" formControlName="ciudad" required>
                    <app-form-error [control]="personalInfo.get('ciudad')" message="Hay errores con la ciudad.">
                    </app-form-error>
                </div>

                <!-- Teléfono -->
                <div class="form-group mb-3">
                    <label for="telefono" class="text-naranja">Teléfono</label>
                    <input id="telefono" type="text" class="form-control" formControlName="telefono" required>
                    <app-form-error [control]="personalInfo.get('telefono')" message="Hay errores con el teléfono.">
                    </app-form-error>
                </div>

                <!-- Email -->
                <div class="form-group mb-3">
                    <label for="email" class="text-naranja">Email</label>
                    <input id="email" type="email" class="form-control" formControlName="email" required>
                    <app-form-error [control]="personalInfo.get('email')" message="Hay errores con el email.">
                    </app-form-error>
                </div>
            </form>
        </mat-step>

        <!-- ========== STEP 2 (solo infantiles): RESPONSABLE ========== -->
        @if (personalInfo.get('tipoCandidata')?.value === 'infantiles') {
        <mat-step [stepControl]="responsableInfo">
            <form [formGroup]="responsableInfo">
                <ng-template matStepLabel>Información del Responsable</ng-template>

                <span class="text-rojo mb-2 d-block">
                    En caso de que exista limitación de la patria potestad por parte de algún tutor o tutora legal de la
                    menor, indicad sólo el nombre y teléfono de la persona que la ostente.
                </span>

                <!-- Tutor 1 -->
                <div class="form-group mb-3">
                    <label for="nombreTutor1" class="text-naranja">Nombre del/la Tutor/a 1</label>
                    <input id="nombreTutor1" type="text" class="form-control" formControlName="nombreTutor1" required>
                    <app-form-error [control]="responsableInfo.get('nombreTutor1')"
                        message="Hay errores con el nombre.">
                    </app-form-error>
                </div>

                <!-- Teléfono tutor 1 -->
                <div class="form-group mb-3">
                    <label for="telefonoTutor1" class="text-naranja">Teléfono del/la Tutor/a 1</label>
                    <input id="telefonoTutor1" type="text" class="form-control" formControlName="telefonoTutor1"
                        required>
                    <app-form-error [control]="responsableInfo.get('telefonoTutor1')"
                        message="Hay errores con el teléfono.">
                    </app-form-error>
                </div>

                <!-- Tutor 2 (opcionales) -->
                <div class="form-group mb-3">
                    <label for="nombreTutor2" class="text-naranja">Nombre del/la Tutor/a 2</label>
                    <input id="nombreTutor2" type="text" class="form-control" formControlName="nombreTutor2">
                </div>
                <div class="form-group mb-3">
                    <label for="telefonoTutor2" class="text-naranja">Teléfono del/la Tutor/a 2</label>
                    <input id="telefonoTutor2" type="text" class="form-control" formControlName="telefonoTutor2">
                </div>
            </form>
        </mat-step>
        }

        <!-- ========== STEP: DATOS DE LA FIESTA ========== -->
        <mat-step [stepControl]="fogueresInfo">
            <form [formGroup]="fogueresInfo">
                <ng-template matStepLabel>Datos de la fiesta</ng-template>

                <!-- Asociación -->
                <div class="form-group mb-3">
                    <label for="asociacion" class="text-naranja">Asociación</label>
                    <select id="asociacion" class="form-control" formControlName="asociacion" required>
                        @for (asociacion of asociaciones; track $index) {
                        <option [value]="asociacion.id">{{ asociacion.nombre }}</option>
                        }
                    </select>
                    <app-form-error [control]="fogueresInfo.get('asociacion')"
                        message="Hay errores con la asociación, por favor, selecciona una de la lista.">
                    </app-form-error>
                </div>

                <!-- Años fiesta -->
                <div class="form-group mb-3">
                    <label for="anyosFiesta" class="text-naranja">Años en la Fiesta</label>
                    <input id="anyosFiesta" type="number" class="form-control" formControlName="anyosFiesta" required>
                    <app-form-error [control]="fogueresInfo.get('anyosFiesta')"
                        message="Hay errores con la cantidad introducida, por favor, introduce un valor válido.">
                    </app-form-error>
                </div>

                <!-- Curriculum -->
                <div formGroupName="curriculum">
                    <span class="h3 text-naranja">Curriculum festero</span>

                    <div class="form-group my-3">
                        <label for="cargo" class="text-naranja">Cargo</label>
                        <input id="cargo" type="text" class="form-control" formControlName="cargo">
                    </div>

                    <div class="d-flex justify-content-between align-items-end gap-2">
                        <div class="form-group mb-3">
                            <label for="comienzo" class="text-naranja">Desde</label>
                            <input id="comienzo" type="number" placeholder="aaaa" class="form-control"
                                formControlName="comienzo" min="0" max="2025">
                        </div>
                        <div class="form-group mb-3">
                            <label for="final" class="text-naranja">Hasta</label>
                            <input id="final" type="number" placeholder="aaaa" class="form-control"
                                formControlName="final" min="0" max="2025">
                        </div>
                        <button type="button" style="height: 38px;" class="btn btn-primary"
                            (click)="addCurriculum()">Añadir</button>
                    </div>

                    <ul class="mt-3">
                        @for (cargo of cargos; track cargo; let i = $index) {
                        <li class="d-flex align-items-center gap-2">
                            <span>
                                {{ cargo.cargo | titlecase }} -
                                @if (cargo.comienzo === cargo.final) {
                                Año {{ cargo.comienzo }}
                                } @else {
                                Años {{ cargo.comienzo }} - {{ cargo.final }}
                                }
                            </span>
                            <button mat-icon-button color="warn" (click)="removeCurriculum(i)">
                                <mat-icon>close</mat-icon>
                            </button>
                        </li>
                        }
                    </ul>
                </div>
            </form>
        </mat-step>

        <!-- ========== STEP: ACADÉMICO / INFO ADICIONAL ========== -->
        <mat-step [stepControl]="academicInfo">
            <form [formGroup]="academicInfo">
                <ng-template matStepLabel>Formación e información adicional</ng-template>

                <!-- Formación -->
                <div class="form-group mb-3">
                    <label for="formacion" class="text-naranja">Formación</label>
                    <input id="formacion" type="text" class="form-control" formControlName="formacion" required>
                    <app-form-error [control]="academicInfo.get('formacion')" message="La formación es obligatoria.">
                    </app-form-error>
                </div>

                <!-- Situación laboral solo adultas -->
                @if (personalInfo.get('tipoCandidata')?.value === 'adultas') {
                <div class="form-group mb-3">
                    <label for="situacionLaboral" class="text-naranja">Situación Laboral</label>
                    <input id="situacionLaboral" type="text" class="form-control" formControlName="situacionLaboral"
                        required>
                    <app-form-error [control]="academicInfo.get('situacionLaboral')"
                        message="La situación laboral es obligatoria para adultas.">
                    </app-form-error>
                </div>
                }

                <!-- Aficiones -->
                <div class="form-group mb-3">
                    <label for="aficiones" class="text-naranja">Aficiones</label>
                    <input id="aficiones" type="text" class="form-control" formControlName="aficiones" required>
                    <app-form-error [control]="academicInfo.get('aficiones')" message="Las aficiones son obligatorias.">
                    </app-form-error>
                </div>

                <!-- Checkbox observaciones -->
                <div class="form-group mb-3">
                    <mat-checkbox formControlName="aceptoTratamiento" (change)="toggleObservaciones($event)"
                        class="text-rojo">
                        Acepto el tratamiento de mis "observaciones"
                    </mat-checkbox>
                </div>

                <!-- Observaciones -->
                <div class="form-group mb-3">
                    <label for="observaciones" class="text-naranja">Observaciones (alergias, intolerancias...)</label>
                    <textarea id="observaciones" class="form-control" formControlName="observaciones"></textarea>
                    <app-form-error [control]="academicInfo.get('observaciones')"
                        message="Hay algún error, por favor, revisa las observaciones.">
                    </app-form-error>
                </div>
            </form>
        </mat-step>
        }

        <!-- ========== STEP: DOCUMENTACIÓN (siempre) ========== -->
        <mat-step [stepControl]="documentacionForm">
            <ng-template matStepLabel>Documentación</ng-template>
            <form [formGroup]="documentacionForm">

                @for (f of fileFields; track f.name) {
                <div class="form-group mb-3">
                    <label [for]="f.name" class="text-naranja">{{ f.label }}</label>
                    <input [id]="f.name" type="file" class="form-control" (change)="onFileChange($event, f.name)">
                    <app-form-error [control]="documentacionForm.get(f.name)"
                        message="El archivo debe pesar menos de 5MB.">
                    </app-form-error>
                </div>
                }

            </form>
        </mat-step>

    </mat-stepper>

    <div class="container mt-3">
        <button type="submit" class="btn btn-primary btn-foc-rojo w-100" (click)="procesar()"
            [disabled]="personalInfo.invalid || academicInfo.invalid || fogueresInfo.invalid || documentacionForm.invalid">
            Enviar
        </button>
    </div>
</div>
}